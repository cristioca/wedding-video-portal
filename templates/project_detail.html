{% extends 'base.html' %}
{% load project_filters %}

{% block title %}{{ project.name }} - Wedding Video Portal{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2 class="text-white">{{ project.name }}</h2>
        <p class="text-white-50">
            <i class="bi bi-person"></i> {{ project.client_name|default:project.user.get_full_name|default:project.user.username }}
            | <i class="bi bi-calendar"></i> {{ project.event_date|date:"M d, Y" }}
        </p>
        {% if is_admin %}
        <div class="mt-2">
            <button class="btn btn-light btn-sm js-send-credentials" data-project-id="{{ project.slug }}" style="background-color: rgba(85, 215, 255, 0.7); border: 1px solid rgba(255, 255, 255, 0.3);">
                <i class="bi bi-envelope-at"></i> Send credentials email
            </button>
            <button class="btn btn-light btn-sm js-change-client" data-project-id="{{ project.slug }}" style="background-color: rgba(85, 255, 105, 0.5); border: 1px solid rgba(255, 255, 255, 0.3);">
                <i class="bi bi-person-gear"></i> Change client data
            </button>
        </div>
        {% endif %}
    </div>
    <div class="col-auto">
        {% if is_admin %}
        <!-- Always show notify button, but style differently based on changes -->
        <button class="btn {% if project.has_unsent_changes %}btn-warning{% else %}btn-secondary{% endif %} js-notify" data-project-id="{{ project.slug }}">
            <i class="bi bi-envelope"></i> Notify Client
        </button>
        <!-- Show clear button only when there are changes, with less contrast -->
        {% if project.has_unsent_changes %}
        <button class="btn btn-outline-secondary opacity-75 js-clear-notify" data-project-id="{{ project.slug }}">
            <i class="bi bi-bell-slash"></i> Clear notification
        </button>
        {% else %}
        <button class="btn btn-outline-secondary opacity-50" disabled>
            <i class="bi bi-bell-slash"></i> Clear notification
        </button>
        {% endif %}
        <button class="btn btn-warning btn-sm me-2 js-archive-project" data-project-id="{{ project.slug }}" data-url="{% url 'archive_project' project.slug %}">
            <i class="bi bi-archive"></i> Archive
        </button>
        <button class="btn btn-danger btn-sm js-delete-project" data-project-id="{{ project.slug }}" data-url="{% url 'delete_project' project.slug %}">
            <i class="bi bi-trash"></i> Delete
        </button>
        {% endif %}
    </div>
</div>

{% if is_admin and modifications %}
<div class="card mb-4">
    <div class="card-header bg-warning text-dark">
        <i class="bi bi-exclamation-triangle"></i> Pending Modifications
    </div>
    <div class="card-body">
        {% for mod in modifications %}
        <div class="border rounded p-3 mb-2">
            <div class="row">
                <div class="col-md-8">
                    <h6>{{ mod.field_name|title }}</h6>
                    <p class="mb-1"><strong>Old:</strong> {{ mod.old_value|default:"(empty)" }}</p>
                    <p class="mb-1"><strong>New:</strong> {{ mod.new_value|default:"(empty)" }}</p>
                    <small class="text-muted">By {{ mod.created_by.get_full_name|default:mod.created_by.email }} - {{ mod.created_at|timesince }} ago</small>
                </div>
                <div class="col-md-4 text-end">
                    <form method="post" action="{% url 'approve_modification' mod.pk %}" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="approve">
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="bi bi-check"></i> Approve
                        </button>
                    </form>
                    <button type="button" class="btn btn-danger btn-sm" onclick="showRejectModal({{ mod.pk }}, '{{ mod.field_name|title }}')">
                        <i class="bi bi-x"></i> Reject
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if not is_admin %}
<!-- Show rejected modifications to clients -->
{% with all_modifications=project.modifications.all|dictsortreversed:"created_at" %}
{% if all_modifications %}
<div class="card mb-4" id="rejectedModificationsCard">
    <div class="card-header d-flex justify-content-between align-items-center" 
         style="cursor: pointer; background-color: rgba(108, 117, 125, 0.15); border-bottom: 1px solid rgba(220, 53, 69, 0.2); padding: 0.25rem 0.75rem; font-size: 0.8rem;" 
         onclick="toggleRejectedSection()" 
         data-bs-toggle="collapse" 
         data-bs-target="#rejectedModificationsBody" 
         aria-expanded="false" 
         aria-controls="rejectedModificationsBody">
        <div class="d-flex align-items-center">
            <i class="bi bi-x-circle me-2 text-muted" style="font-size: 0.75rem; opacity: 0.6;"></i>
            <span id="rejectedSectionTitle" class="text-muted" style="opacity: 0.7;">Rejected Change Requests</span>
            <span class="badge text-muted ms-2" style="font-size: 0.65rem; padding: 0.15rem 0.4rem; background-color: rgba(220, 53, 69, 0.15);" id="rejectedCount">0</span>
        </div>
        <div class="d-flex align-items-center">
            <i class="bi bi-chevron-up me-2 text-muted" id="rejectedChevron" style="font-size: 0.7rem; opacity: 0.5;"></i>
            <button type="button" class="btn btn-sm text-muted" onclick="dismissRejectedSection(event)" title="Dismiss notifications" style="padding: 0.1rem 0.3rem; font-size: 0.7rem; border: 1px solid rgba(108, 117, 125, 0.3); opacity: 0.6;">
                <i class="bi bi-eye-slash"></i>
            </button>
        </div>
    </div>
    <div class="collapse" id="rejectedModificationsBody">
        <div class="card-body">
            {% for mod in all_modifications %}
            {% if mod.status == 'REJECTED' %}
            <div class="border rounded p-3 mb-2 border-danger">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="text-danger">{{ mod.field_name|title }}</h6>
                        <p class="mb-1"><strong>Your Request:</strong> {{ mod.new_value|default:"(empty)" }}</p>
                        <p class="mb-1"><strong>Original Value:</strong> {{ mod.old_value|default:"(empty)" }}</p>
                        {% if mod.notes %}
                        <div class="alert alert-warning mt-2 mb-2">
                            <strong><i class="bi bi-exclamation-triangle me-1"></i>Rejection Reason:</strong><br>
                            {{ mod.notes|linebreaks }}
                        </div>
                        {% endif %}
                        <small class="text-muted">
                            Rejected by {{ mod.approved_by.get_full_name|default:mod.approved_by.email }} - {{ mod.approved_at|timesince }} ago
                        </small>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-danger">
                            <i class="bi bi-x-circle"></i> Rejected
                        </span>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
            <div class="text-center mt-3">
                <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Review the feedback above and submit new change requests with corrections.
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Minimized rejected notifications bar (hidden by default) -->
<div class="d-none border-start border-warning border-2 ps-2 mb-1" 
     id="rejectedMinimizedBar" 
     onclick="showRejectedSection()" 
     style="cursor: pointer; background-color: rgba(255, 193, 7, 0.05); font-size: 0.75rem; padding-top: 2px; padding-bottom: 2px; line-height: 1.2;">
    <div class="d-flex justify-content-between align-items-center">
        <div class="text-muted">
            <i class="bi bi-exclamation-triangle me-1" style="font-size: 0.7rem;"></i>
            <span id="rejectedMinimizedCount">0 rejected changes</span>
            <small class="ms-1 opacity-50" style="font-size: 0.65rem;">• click to review</small>
        </div>
        <i class="bi bi-chevron-up text-muted opacity-50" style="font-size: 0.6rem;"></i>
    </div>
</div>
{% endif %}
{% endwith %}
{% endif %}

<div class="row">
    <div class="col-lg-8">
        <!-- Project Phase Navigation -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-white mb-0">Project Workflow</h6>
            <div class="btn-group" role="group" aria-label="Project phases">
                <button type="button" class="btn btn-outline-secondary btn-sm active" id="preproduction-tab" onclick="switchTab('preproduction')">
                    <i class="bi bi-clipboard-check"></i> Details
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="production-tab" onclick="switchTab('production')">
                    <i class="bi bi-film"></i> Production
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="download-tab" onclick="switchTab('download')" disabled>
                    <i class="bi bi-download"></i> Download
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="approval-tab" onclick="switchTab('approval')" disabled>
                    <i class="bi bi-check-circle"></i> Approval
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="feedback-tab" onclick="switchTab('feedback')" disabled>
                    <i class="bi bi-chat-dots"></i> Feedback
                </button>
            </div>
        </div>

        <!-- Planning Tab (Current Project Details) -->
        <div class="tab-content" id="preproduction-content">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-info-circle"></i> Project Details
                </div>
            <div class="card-body">
                <!-- Basic Information -->
                <div class="editable-section mb-4" data-section="basic">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <h6 class="mb-0">Basic Information</h6>
                            <button class="btn btn-link btn-sm p-0 ms-2 text-info" type="button" data-bs-toggle="collapse" data-bs-target="#infoBasic" aria-expanded="false" aria-controls="infoBasic" title="Show info">
                                <i class="bi bi-info-circle" style="font-size: 0.9rem;"></i>
                            </button>
                        </div>
                        <button class="btn btn-sm btn-outline-primary edit-btn" data-section="basic">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                    </div>
                    <div class="collapse mb-3" id="infoBasic">
                        <div class="alert alert-info py-2 px-3" style="font-size: 0.85rem; color: inherit;">
                            <i class="bi bi-lightbulb me-1"></i>
                            The main details about the event. These are usually filled by the videographer, but if you need to make a change, please do so. The changes will be reviewed and will appear when approved by the videographer.
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Project Name</label>
                            <div class="view-mode">
                                <p class="form-control-plaintext">{{ project.name }}</p>
                            </div>
                            <div class="edit-mode" style="display: none;">
                                <input type="text" class="form-control" data-field="name" value="{{ project.name }}">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Client</label>
                            <div class="view-mode">
                                <p class="form-control-plaintext">{{ project.client_name|default:project.user.get_full_name|default:project.user.username }}</p>
                                {% if project.client_email %}
                                <small class="text-muted">{{ project.client_email }}</small>
                                {% endif %}
                            </div>
                            <div class="edit-mode" style="display: none;">
                                <input type="text" class="form-control mb-2" data-field="client_name" value="{{ project.client_name|default:'' }}" placeholder="Client name">
                                <input type="email" class="form-control" data-field="client_email" value="{{ project.client_email|default:'' }}" placeholder="Client email">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Type</label>
                            <div class="view-mode">
                                <p class="form-control-plaintext">{{ project.get_type_display }}</p>
                            </div>
                            <div class="edit-mode" style="display: none;">
                                <select class="form-control" data-field="type">
                                    {% for value, label in form.type.field.choices %}
                                    <option value="{{ value }}" {% if value == project.type %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Status</label>
                            <div class="view-mode">
                                <p class="form-control-plaintext">{{ project.get_status_display }}</p>
                            </div>
                            {% if is_admin %}
                            <div class="edit-mode" style="display: none;">
                                <select class="form-control" data-field="status">
                                    {% for value, label in form.status.field.choices %}
                                    <option value="{{ value }}" {% if value == project.status %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Edit Status</label>
                            <div class="view-mode">
                                <p class="form-control-plaintext">{{ project.get_edit_status_display }}</p>
                            </div>
                            {% if is_admin %}
                            <div class="edit-mode" style="display: none;">
                                <select class="form-control" data-field="edit_status">
                                    {% for value, label in form.edit_status.field.choices %}
                                    <option value="{{ value }}" {% if value == project.edit_status %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Event Date</label>
                            <div class="view-mode">
                                <p class="form-control-plaintext">{{ project.event_date|date:"Y-m-d" }}</p>
                            </div>
                            <div class="edit-mode" style="display: none;">
                                <input type="date" class="form-control" data-field="event_date" value="{{ project.event_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">City</label>
                            <div class="view-mode">
                                <p class="form-control-plaintext">{{ project.city|default:"Not specified" }}</p>
                            </div>
                            <div class="edit-mode" style="display: none;">
                                <input type="text" class="form-control" data-field="city" value="{{ project.city|default:'' }}">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Video Title</label>
                        <div class="view-mode">
                            <p class="form-control-plaintext">{{ project.title_video|default:"Not specified" }}</p>
                        </div>
                        <div class="edit-mode" style="display: none;">
                            <input type="text" class="form-control" data-field="title_video" value="{{ project.title_video|default:'' }}">
                        </div>
                    </div>
                    
                    <div class="edit-actions" style="display: none;">
                        <button class="btn btn-success btn-sm me-2 save-btn" data-section="basic">
                            <i class="bi bi-check"></i> Save
                        </button>
                        <button class="btn btn-secondary btn-sm cancel-btn" data-section="basic">
                            <i class="bi bi-x"></i> Cancel
                        </button>
                    </div>
                </div>

                <!-- Event Details -->
                <div class="editable-section mb-4" data-section="ceremony">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <h6 class="mb-0">Event Details</h6>
                            <button class="btn btn-link btn-sm p-0 ms-2 text-info" type="button" data-bs-toggle="collapse" data-bs-target="#infoCeremony" aria-expanded="false" aria-controls="infoCeremony" title="Show info">
                                <i class="bi bi-info-circle" style="font-size: 0.9rem;"></i>
                            </button>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary reorder-btn" data-section="ceremony" title="Reorder fields">
                                <i class="bi bi-arrows-move"></i> Reorder
                            </button>
                            <button class="btn btn-sm btn-outline-primary edit-btn" data-section="ceremony">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                        </div>
                    </div>
                    <div class="collapse mb-3" id="infoCeremony">
                        <div class="alert alert-info py-2 px-3" style="font-size: 0.85rem; color: inherit;">
                            <i class="bi bi-lightbulb me-1"></i>
                            Fill in the details about the main moments of your event. They can be reordered if needed. The changes will be sent to and reviewed by the videographer and will appear when approved.
                        </div>
                    </div>
                    
                    <div id="ceremony-fields-container" class="ceremony-fields">
                        {% for field_info in ceremony_fields %}
                        <div class="ceremony-field-item mb-3" data-field-name="{{ field_info.field }}">
                            <div class="drag-handle" style="display: none;">
                                <i class="bi bi-grip-vertical text-muted"></i>
                            </div>
                            <div class="field-content col-md-6 d-inline-block">
                                <label class="form-label">{{ field_info.label }}</label>
                                <div class="view-mode">
                                    <p class="form-control-plaintext">{{ project|attr:field_info.field|default:"Not specified" }}</p>
                                </div>
                                <div class="edit-mode" style="display: none;">
                                    <textarea class="form-control" data-field="{{ field_info.field }}" rows="{{ field_info.rows }}">{{ project|attr:field_info.field|default:'' }}</textarea>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="reorder-actions" style="display: none;">
                        <button class="btn btn-success btn-sm me-2 save-order-btn" data-section="ceremony">
                            <i class="bi bi-check"></i> Save Order
                        </button>
                        <button class="btn btn-secondary btn-sm cancel-reorder-btn" data-section="ceremony">
                            <i class="bi bi-x"></i> Cancel
                        </button>
                    </div>
                    
                    <div class="edit-actions" style="display: none;">
                        <button class="btn btn-success btn-sm me-2 save-btn" data-section="ceremony">
                            <i class="bi bi-check"></i> Save
                        </button>
                        <button class="btn btn-secondary btn-sm cancel-btn" data-section="ceremony">
                            <i class="bi bi-x"></i> Cancel
                        </button>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="editable-section mb-4" data-section="additional">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <h6 class="mb-0">Additional Information</h6>
                            <button class="btn btn-link btn-sm p-0 ms-2 text-info" type="button" data-bs-toggle="collapse" data-bs-target="#infoAdditional" aria-expanded="false" aria-controls="infoAdditional" title="Show info">
                                <i class="bi bi-info-circle" style="font-size: 0.9rem;"></i>
                            </button>
                        </div>
                        <button class="btn btn-sm btn-outline-primary edit-btn" data-section="additional">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                    </div>
                    <div class="collapse mb-3" id="infoAdditional">
                        <div class="alert alert-info py-2 px-3" style="font-size: 0.85rem; color: inherit;">
                            <i class="bi bi-lightbulb me-1"></i>
                            If there are more details to be known and established, or some requests or any other information for the preparation of the event, you can write them here. The changes will be sent to and reviewed by the videographer and will appear when approved.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Extra Details</label>
                        <div class="view-mode">
                            <p class="form-control-plaintext">{{ project.details_extra|default:"Not specified" }}</p>
                        </div>
                        <div class="edit-mode" style="display: none;">
                            <textarea class="form-control" data-field="details_extra" rows="3">{{ project.details_extra|default:'' }}</textarea>
                        </div>
                    </div>
                    
                    <div class="edit-actions" style="display: none;">
                        <button class="btn btn-success btn-sm me-2 save-btn" data-section="additional">
                            <i class="bi bi-check"></i> Save
                        </button>
                        <button class="btn btn-secondary btn-sm cancel-btn" data-section="additional">
                            <i class="bi bi-x"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Production Tab -->
        <div class="tab-content" id="production-content" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-film"></i> Production
                </div>
                <div class="card-body">
                    {% if is_admin %}
                    <!-- Critical Production Details Section (Admin Only) -->
                    <div class="editable-section mb-4" data-section="critical-production" id="critical-production-section">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0 text-danger">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>CRITICAL PRODUCTION DETAILS
                            </h6>
                            <button class="btn btn-sm btn-outline-primary edit-btn" data-section="critical-production">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                        </div>
                        
                        {% if project.critical_production_notes %}
                        <!-- Show field if it has content -->
                        <div class="mb-3">
                            <label class="form-label">Notes only for videographer</label>
                            <div class="view-mode">
                                <p class="form-control-plaintext" style="white-space: pre-wrap;">{{ project.critical_production_notes }}</p>
                            </div>
                            <div class="edit-mode" style="display: none;">
                                <textarea class="form-control" data-field="critical_production_notes" rows="4" placeholder="Critical production notes that must be known...">{{ project.critical_production_notes|default:'' }}</textarea>
                            </div>
                        </div>
                        {% else %}
                        <!-- Hide field when empty, show only in edit mode -->
                        <div class="mb-3" style="display: none;" id="critical-notes-field">
                            <label class="form-label">Notes only for videographer</label>
                            <div class="view-mode">
                                <p class="form-control-plaintext" style="white-space: pre-wrap;">Not specified</p>
                            </div>
                            <div class="edit-mode">
                                <textarea class="form-control" data-field="critical_production_notes" rows="4" placeholder="Critical production notes that must be known...">{{ project.critical_production_notes|default:'' }}</textarea>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="edit-actions" style="display: none;">
                            <button class="btn btn-success btn-sm me-2 save-btn" data-section="critical-production">
                                <i class="bi bi-check"></i> Save
                            </button>
                            <button class="btn btn-secondary btn-sm cancel-btn" data-section="critical-production">
                                <i class="bi bi-x"></i> Cancel
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Filming Section -->
                    <div class="editable-section mb-4" data-section="filming">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                <h6 class="mb-0">Filming</h6>
                                <button class="btn btn-link btn-sm p-0 ms-2 text-info" type="button" data-bs-toggle="collapse" data-bs-target="#infoFilming" aria-expanded="false" aria-controls="infoFilming" title="Show info">
                                    <i class="bi bi-info-circle" style="font-size: 0.9rem;"></i>
                                </button>
                            </div>
                            <button class="btn btn-sm btn-outline-primary edit-btn" data-section="filming">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                        </div>
                        <div class="collapse mb-3" id="infoFilming">
                            <div class="alert alert-info py-2 px-3" style="font-size: 0.85rem; color: inherit;">
                                <i class="bi bi-lightbulb me-1"></i>
                                Insert here any specific information that is relevant to you about the event or the people attending that must be known by the videographer to prepare for filming. Please fill this before the day of the event.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                Filming Details (Client Requests)
                                {% if filming_details_history %}
                                <button type="button" class="btn btn-link btn-sm p-0 ms-2 text-info history-btn" 
                                        data-field="filming_details" 
                                        title="View edit history" 
                                        style="font-size: 0.85rem; text-decoration: none;">
                                    <i class="bi bi-clock-history"></i>
                                </button>
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    Last edited: {{ filming_details_history.first.created_at|date:"M d, Y H:i" }}
                                </small>
                                {% else %}
                                <button type="button" class="btn btn-link btn-sm p-0 ms-2 text-muted opacity-50 history-btn" 
                                        data-field="filming_details" 
                                        title="No edit history" 
                                        style="font-size: 0.85rem; text-decoration: none;" disabled>
                                    <i class="bi bi-clock-history"></i>
                                </button>
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    No edits yet
                                </small>
                                {% endif %}
                            </label>
                            <div class="view-mode">
                                <p class="form-control-plaintext" style="white-space: pre-wrap;">{{ project.filming_details|default:"Not specified" }}</p>
                            </div>
                            <div class="edit-mode" style="display: none;">
                                <textarea class="form-control" data-field="filming_details" rows="4" placeholder="Insert here any details that the filming team should know about. Anything you like and don't like in particular, so we can follow your directions.">{{ project.filming_details|default:'' }}</textarea>
                            </div>
                        </div>
                        
                        <div class="mb-3 videographer-notes-field">
                            <label class="form-label">Videographer Notes for Filming</label>
                            <div class="view-mode">
                                <p class="form-control-plaintext" style="white-space: pre-wrap;">{{ project.videographer_filming_notes|default:"Not specified" }}</p>
                            </div>
                            {% if is_admin %}
                            <div class="edit-mode" style="display: none;">
                                <textarea class="form-control" data-field="videographer_filming_notes" rows="4" placeholder="Videographer's internal notes for filming...">{{ project.videographer_filming_notes|default:'' }}</textarea>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="edit-actions" style="display: none;">
                            <button class="btn btn-success btn-sm me-2 save-btn" data-section="filming">
                                <i class="bi bi-check"></i> Save
                            </button>
                            <button class="btn btn-secondary btn-sm cancel-btn" data-section="filming">
                                <i class="bi bi-x"></i> Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Editing Status -->
                    <div class="editable-section mb-4" data-section="editing-status">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                <h6 class="mb-0">Editing Progress</h6>
                                <button class="btn btn-link btn-sm p-0 ms-2 text-info" type="button" data-bs-toggle="collapse" data-bs-target="#infoEditingStatus" aria-expanded="false" aria-controls="infoEditingStatus" title="Show info">
                                    <i class="bi bi-info-circle" style="font-size: 0.9rem;"></i>
                                </button>
                            </div>
                            {% if is_admin %}
                            <button class="btn btn-sm btn-outline-primary edit-btn" data-section="editing-status">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            {% endif %}
                        </div>
                        <div class="collapse mb-3" id="infoEditingStatus">
                            <div class="alert alert-info py-2 px-3" style="font-size: 0.85rem; color: inherit;">
                                <i class="bi bi-lightbulb me-1"></i>
                                This section shows the status of the editing process. This can be modified only by the videographer.
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Current Phase</label>
                                <div class="view-mode">
                                    <p class="form-control-plaintext">{{ project.get_edit_status_display }}</p>
                                </div>
                                {% if is_admin %}
                                <div class="edit-mode" style="display: none;">
                                    <select class="form-control" data-field="edit_status">
                                        {% for value, label in form.edit_status.field.choices %}
                                        <option value="{{ value }}" {% if value == project.edit_status %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Progress</label>
                                <div class="view-mode">
                                    <div class="progress">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ project.editing_progress }}%" aria-valuenow="{{ project.editing_progress }}" aria-valuemin="0" aria-valuemax="100">{{ project.editing_progress }}%</div>
                                    </div>
                                    <small class="text-muted mt-1">Estimated completion</small>
                                </div>
                                {% if is_admin %}
                                <div class="edit-mode" style="display: none;">
                                    <input type="number" class="form-control" data-field="editing_progress" value="{{ project.editing_progress }}" min="0" max="100" step="5">
                                    <small class="text-muted">Enter percentage (0-100)</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if is_admin %}
                        <div class="edit-actions" style="display: none;">
                            <button class="btn btn-success btn-sm me-2 save-btn" data-section="editing-status">
                                <i class="bi bi-check"></i> Save
                            </button>
                            <button class="btn btn-secondary btn-sm cancel-btn" data-section="editing-status">
                                <i class="bi bi-x"></i> Cancel
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Editing Notes -->
                    <div class="editable-section mb-4" data-section="editing-notes">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                <h6 class="mb-0">Editing Notes</h6>
                                <button class="btn btn-link btn-sm p-0 ms-2 text-info" type="button" data-bs-toggle="collapse" data-bs-target="#infoEditingNotes" aria-expanded="false" aria-controls="infoEditingNotes" title="Show info">
                                    <i class="bi bi-info-circle" style="font-size: 0.9rem;"></i>
                                </button>
                            </div>
                            <button class="btn btn-sm btn-outline-primary edit-btn" data-section="editing-notes">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                        </div>
                        <div class="collapse mb-3" id="infoEditingNotes">
                            <div class="alert alert-info py-2 px-3" style="font-size: 0.85rem; color: inherit;">
                                <i class="bi bi-lightbulb me-1"></i>
                                Insert here any specific information that is relevant to the editing process (e.g., length of the ceremony, details to include or exclude, coloring preferences, song preferences, etc.). These will be taken as suggestions by the videographer. Please fill them before the editing process is complete.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                Editing Notes (Client Requests)
                                {% if notes_history %}
                                <button type="button" class="btn btn-link btn-sm p-0 ms-2 text-info history-btn" 
                                        data-field="notes" 
                                        title="View edit history" 
                                        style="font-size: 0.85rem; text-decoration: none;">
                                    <i class="bi bi-clock-history"></i>
                                </button>
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    Last edited: {{ notes_history.first.created_at|date:"M d, Y H:i" }}
                                </small>
                                {% else %}
                                <button type="button" class="btn btn-link btn-sm p-0 ms-2 text-muted opacity-50 history-btn" 
                                        data-field="notes" 
                                        title="No edit history" 
                                        style="font-size: 0.85rem; text-decoration: none;" disabled>
                                    <i class="bi bi-clock-history"></i>
                                </button>
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    No edits yet
                                </small>
                                {% endif %}
                            </label>
                            <div class="view-mode">
                                <p class="form-control-plaintext" style="white-space: pre-wrap;">{{ project.notes|default:"No editing notes yet" }}</p>
                            </div>
                            <div class="edit-mode" style="display: none;">
                                <textarea class="form-control" data-field="notes" rows="4" placeholder="Add editing notes, production decisions, technical details...">{{ project.notes|default:'' }}</textarea>
                            </div>
                        </div>
                        
                        <div class="mb-3 videographer-notes-field">
                            <label class="form-label">Videographer Notes for Editing</label>
                            <div class="view-mode">
                                <p class="form-control-plaintext" style="white-space: pre-wrap;">{{ project.videographer_editing_notes|default:"Not specified" }}</p>
                            </div>
                            {% if is_admin %}
                            <div class="edit-mode" style="display: none;">
                                <textarea class="form-control" data-field="videographer_editing_notes" rows="4" placeholder="Videographer's internal notes for editing...">{{ project.videographer_editing_notes|default:'' }}</textarea>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="edit-actions" style="display: none;">
                            <button class="btn btn-success btn-sm me-2 save-btn" data-section="editing-notes">
                                <i class="bi bi-check"></i> Save
                            </button>
                            <button class="btn btn-secondary btn-sm cancel-btn" data-section="editing-notes">
                                <i class="bi bi-x"></i> Cancel
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Future Tabs (Placeholder) -->
        <div class="tab-content" id="download-content" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-download"></i> Download & Delivery
                </div>
                <div class="card-body">
                    <p class="text-muted">Download functionality coming soon...</p>
                </div>
            </div>
        </div>

        <div class="tab-content" id="approval-content" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-check-circle"></i> Client Approval
                </div>
                <div class="card-body">
                    <p class="text-muted">Approval workflow coming soon...</p>
                </div>
            </div>
        </div>

        <div class="tab-content" id="feedback-content" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-chat-dots"></i> Client Feedback
                </div>
                <div class="card-body">
                    <p class="text-muted">Feedback system coming soon...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Package Section - Admin can edit, Client can view -->
        <div class="card mb-4 editable-section" data-section="package">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-box-seam"></i> Package
                    {% if is_admin %}
                    <span class="badge bg-primary ms-2">Admin Editable</span>
                    {% else %}
                    <span class="badge bg-secondary ms-2">Client View</span>
                    {% endif %}
                </div>
                {% if is_admin %}
                <button class="btn btn-outline-light btn-sm edit-btn" data-section="package">
                    <i class="bi bi-pencil"></i> Edit
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if is_admin %}
                <!-- Admin View - Editable Package Section -->
                <!-- Package Type -->
                <div class="mb-3">
                    <label class="form-label">Package Type</label>
                    <div class="view-mode">
                        <p class="form-control-plaintext">{{ project.package_type|default:"Not specified" }}</p>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <select class="form-control" data-field="package_type">
                            <option value="">Select Package</option>
                            <option value="Clasic" {% if project.package_type == 'Clasic' %}selected{% endif %}>Clasic</option>
                            <option value="Highlights" {% if project.package_type == 'Highlights' %}selected{% endif %}>Highlights</option>
                            <option value="Duo" {% if project.package_type == 'Duo' %}selected{% endif %}>Duo</option>
                            <option value="Cinema" {% if project.package_type == 'Cinema' %}selected{% endif %}>Cinema</option>
                            <option value="Creative" {% if project.package_type == 'Creative' %}selected{% endif %}>Creative</option>
                            <option value="Botez" {% if project.package_type == 'Botez' %}selected{% endif %}>Botez</option>
                            <option value="Custom" {% if project.package_type == 'Custom' %}selected{% endif %}>Custom</option>
                        </select>
                    </div>
                </div>

                <!-- Size Format -->
                <div class="mb-3">
                    <label class="form-label">Size Format</label>
                    <div class="view-mode">
                        <div class="form-control-plaintext">
                            {% if project.package_4k %}<i class="bi bi-check text-success"></i> 4K<br>{% endif %}
                            {% if project.package_fullhd %}<i class="bi bi-check text-success"></i> FullHD<br>{% endif %}
                            {% if not project.package_4k and not project.package_fullhd %}
                                <span class="text-muted">No format selected</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" data-field="package_4k" 
                                   {% if project.package_4k %}checked{% endif %}>
                            <label class="form-check-label">4K</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" data-field="package_fullhd" 
                                   {% if project.package_fullhd %}checked{% endif %}>
                            <label class="form-check-label">FullHD</label>
                        </div>
                    </div>
                </div>

                <!-- Number of Cameras -->
                <div class="mb-3">
                    <label class="form-label">No of cameras</label>
                    <div class="view-mode">
                        <p class="form-control-plaintext">{{ project.package_cameras|default:"Not specified" }}</p>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <div class="form-check">
                            <input type="radio" name="package_cameras" value="1" class="form-check-input" data-field="package_cameras"
                                   {% if project.package_cameras == 1 %}checked{% endif %}>
                            <label class="form-check-label">1</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" name="package_cameras" value="2" class="form-check-input" data-field="package_cameras"
                                   {% if project.package_cameras == 2 %}checked{% endif %}>
                            <label class="form-check-label">2</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" name="package_cameras" value="3" class="form-check-input" data-field="package_cameras"
                                   {% if project.package_cameras == 3 %}checked{% endif %}>
                            <label class="form-check-label">3</label>
                        </div>
                    </div>
                </div>

                <!-- Montages -->
                <div class="mb-3">
                    <label class="form-label">Montages</label>
                    <div class="view-mode">
                        <div class="form-control-plaintext">
                            <!-- 1. Highlights clip -->
                            {% if project.montage_highlights %}<i class="bi bi-check text-success"></i> Highlights clip<br>{% endif %}
                            
                            <!-- 2. Cinema style movie -->
                            {% if project.montage_bonus_full %}
                                <i class="bi bi-check text-success"></i> Cinema style movie
                                {% if project.montage_cinema_duration %}
                                    ({{ project.get_montage_cinema_duration_display }})
                                {% endif %}<br>
                            {% endif %}
                            
                            <!-- 3. Full length movie -->
                            {% if project.montage_movie %}
                                <i class="bi bi-check text-success"></i> Full length movie
                                {% if project.montage_movie_duration %}
                                    ({{ project.get_montage_movie_duration_display }}
                                    {% if project.montage_movie_duration == 'Other' and project.montage_movie_other %}: {{ project.montage_movie_other }}{% endif %})
                                {% endif %}<br>
                            {% endif %}
                            
                            <!-- 4. Primary edit -->
                            {% if project.montage_bonus_primary %}<i class="bi bi-check text-success"></i> Primary edit (aprox 4 h)<br>{% endif %}
                            
                            {% if not project.montage_highlights and not project.montage_movie and not project.montage_bonus_primary and not project.montage_bonus_full %}
                                <span class="text-muted">No montages selected</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <!-- 1. Highlights clip -->
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" data-field="montage_highlights"
                                   {% if project.montage_highlights %}checked{% endif %}>
                            <label class="form-check-label">Highlights clip</label>
                        </div>
                        
                        <!-- 2. Cinema style movie -->
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" data-field="montage_bonus_full"
                                   {% if project.montage_bonus_full %}checked{% endif %}>
                            <label class="form-check-label">Cinema style movie</label>
                        </div>
                        <div class="ms-3 mb-2" id="cinema-duration-section" style="{% if not project.montage_bonus_full %}display: none;{% endif %}">
                            <select class="form-control form-control-sm" data-field="montage_cinema_duration">
                                <option value="1h" {% if project.montage_cinema_duration == '1h' %}selected{% endif %}>1 hour</option>
                                <option value="1h30min" {% if project.montage_cinema_duration == '1h30min' or not project.montage_cinema_duration %}selected{% endif %}>1h30min</option>
                            </select>
                        </div>
                        
                        <!-- 3. Full length movie -->
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" data-field="montage_movie"
                                   {% if project.montage_movie %}checked{% endif %}>
                            <label class="form-check-label">Full length movie</label>
                        </div>
                        <div class="ms-3 mb-2" id="movie-duration-section" style="{% if not project.montage_movie %}display: none;{% endif %}">
                            <select class="form-control form-control-sm" data-field="montage_movie_duration">
                                <option value="">Select Duration</option>
                                <option value="30min" {% if project.montage_movie_duration == '30min' %}selected{% endif %}>30 min</option>
                                <option value="1h" {% if project.montage_movie_duration == '1h' %}selected{% endif %}>1 h</option>
                                <option value="1h30min" {% if project.montage_movie_duration == '1h30min' %}selected{% endif %}>1h30min</option>
                                <option value="2h-3h" {% if project.montage_movie_duration == '2h-3h' %}selected{% endif %}>2h-3h</option>
                                <option value="3h-4h" {% if project.montage_movie_duration == '3h-4h' %}selected{% endif %}>3h-4h</option>
                                <option value="Other" {% if project.montage_movie_duration == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                            <input type="text" class="form-control form-control-sm mt-1" 
                                   placeholder="Specify other duration" data-field="montage_movie_other"
                                   value="{{ project.montage_movie_other|default:'' }}"
                                   style="{% if project.montage_movie_duration != 'Other' %}display: none;{% endif %}">
                        </div>
                        
                        <!-- 4. Primary edit -->
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" data-field="montage_bonus_primary"
                                   {% if project.montage_bonus_primary %}checked{% endif %}>
                            <label class="form-check-label">Primary edit (aprox 4 h)</label>
                        </div>
                    </div>
                </div>

                <!-- Equipment Details -->
                <div class="mb-3">
                    <label class="form-label">Equipment details</label>
                    <div class="view-mode">
                        <div class="form-control-plaintext">
                            {% if project.equipment_audio_recorder %}<i class="bi bi-check text-success"></i> External audio recorder(s)<br>{% endif %}
                            {% if project.equipment_stabilizer %}<i class="bi bi-check text-success"></i> Stabilizer<br>{% endif %}
                            {% if project.equipment_external_light %}<i class="bi bi-check text-success"></i> External light<br>{% endif %}
                            {% if not project.equipment_audio_recorder and not project.equipment_stabilizer and not project.equipment_external_light %}
                                <span class="text-muted">No additional equipment</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" data-field="equipment_audio_recorder"
                                   {% if project.equipment_audio_recorder %}checked{% endif %}>
                            <label class="form-check-label">External audio recorder(s)</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" data-field="equipment_stabilizer"
                                   {% if project.equipment_stabilizer %}checked{% endif %}>
                            <label class="form-check-label">Stabilizer</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" data-field="equipment_external_light"
                                   {% if project.equipment_external_light %}checked{% endif %}>
                            <label class="form-check-label">External light</label>
                        </div>
                    </div>
                </div>

                <!-- Team -->
                <div class="mb-3">
                    <label class="form-label">Team</label>
                    <div class="view-mode">
                        <div class="row">
                            <div class="col-4">
                                <small class="text-muted">Videographer</small>
                                <p class="form-control-plaintext">{{ project.team_videographer }}</p>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Operator</small>
                                <p class="form-control-plaintext">{{ project.team_operator }}</p>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Assistant</small>
                                <p class="form-control-plaintext">{{ project.team_assistant }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <div class="row">
                            <div class="col-4">
                                <label class="form-label small">Videographer</label>
                                <input type="number" class="form-control form-control-sm" 
                                       min="0" value="{{ project.team_videographer }}" data-field="team_videographer">
                            </div>
                            <div class="col-4">
                                <label class="form-label small">Operator</label>
                                <input type="number" class="form-control form-control-sm" 
                                       min="0" value="{{ project.team_operator }}" data-field="team_operator">
                            </div>
                            <div class="col-4">
                                <label class="form-label small">Assistant</label>
                                <input type="number" class="form-control form-control-sm" 
                                       min="0" value="{{ project.team_assistant }}" data-field="team_assistant">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delivery Medium -->
                <div class="mb-3">
                    <label class="form-label">Delivery medium</label>
                    <div class="view-mode">
                        <div class="form-control-plaintext">
                            {% if project.delivery_online %}<i class="bi bi-check text-success"></i> Online<br>{% endif %}
                            {% if project.delivery_usb %}<i class="bi bi-check text-success"></i> USB memory stick<br>{% endif %}
                            {% if not project.delivery_online and not project.delivery_usb %}
                                <span class="text-muted">No delivery method selected</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" data-field="delivery_online"
                                   {% if project.delivery_online %}checked{% endif %}>
                            <label class="form-check-label">Online</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" data-field="delivery_usb"
                                   {% if project.delivery_usb %}checked{% endif %}>
                            <label class="form-check-label">USB memory stick</label>
                        </div>
                    </div>
                </div>

                <!-- Event Presence -->
                <div class="mb-3">
                    <label class="form-label">Event presence</label>
                    <div class="view-mode">
                        {% if project.event_presence %}
                        <p class="form-control-plaintext">{{ project.event_presence }}</p>
                        {% else %}
                        <p class="form-control-plaintext text-muted">Not specified</p>
                        {% endif %}
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <textarea class="form-control" data-field="event_presence" rows="3">{{ project.event_presence|default:'' }}</textarea>
                    </div>
                </div>

                <!-- Save/Cancel Buttons -->
                <div class="edit-actions" style="display: none;">
                    <button class="btn btn-success btn-sm me-2 save-btn" data-section="package">
                        <i class="bi bi-check"></i> Save
                    </button>
                    <button class="btn btn-secondary btn-sm cancel-btn" data-section="package">
                        <i class="bi bi-x"></i> Cancel
                    </button>
                </div>

                {% else %}
                <!-- Client View - Read Only -->
                <div class="package-readonly">
                    <!-- Package Type -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Package Type</label>
                        <p class="form-control-plaintext">{{ project.package_type|default:"Not specified" }}</p>
                    </div>
                    
                    <!-- Size Format -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Size Format</label>
                        <div class="form-control-plaintext">
                            {% if project.package_4k %}<i class="bi bi-check text-success"></i> 4K<br>{% endif %}
                            {% if project.package_fullhd %}<i class="bi bi-check text-success"></i> FullHD<br>{% endif %}
                            {% if not project.package_4k and not project.package_fullhd %}
                                <span class="text-muted">No format selected</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Number of Cameras -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">No of cameras</label>
                        <p class="form-control-plaintext">{{ project.package_cameras|default:"Not specified" }}</p>
                    </div>
                    
                    <!-- Montages -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Montages</label>
                        <div class="form-control-plaintext">
                            {% if project.montage_highlights %}<i class="bi bi-check text-success"></i> Highlights clip<br>{% endif %}
                            {% if project.montage_movie %}
                                <i class="bi bi-check text-success"></i> Full length movie
                                {% if project.montage_movie_duration %}
                                    ({{ project.get_montage_movie_duration_display }}
                                    {% if project.montage_movie_duration == 'Other' and project.montage_movie_other %}: {{ project.montage_movie_other }}{% endif %})
                                {% endif %}<br>
                            {% endif %}
                            {% if project.montage_bonus_primary %}<i class="bi bi-check text-success"></i> Primary edit (aprox 4 h)<br>{% endif %}
                            {% if project.montage_bonus_full %}<i class="bi bi-check text-success"></i> Cinema style movie<br>{% endif %}
                            {% if not project.montage_highlights and not project.montage_movie and not project.montage_bonus_primary and not project.montage_bonus_full %}
                                <span class="text-muted">No montages selected</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Equipment Details -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Equipment details</label>
                        <div class="form-control-plaintext">
                            {% if project.equipment_audio_recorder %}<i class="bi bi-check text-success"></i> External audio recorder(s)<br>{% endif %}
                            {% if project.equipment_stabilizer %}<i class="bi bi-check text-success"></i> Stabilizer<br>{% endif %}
                            {% if project.equipment_external_light %}<i class="bi bi-check text-success"></i> External light<br>{% endif %}
                            {% if not project.equipment_audio_recorder and not project.equipment_stabilizer and not project.equipment_external_light %}
                                <span class="text-muted">No additional equipment</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Team -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Team</label>
                        <div class="row">
                            <div class="col-4">
                                <small class="text-muted">Videographer</small>
                                <p class="form-control-plaintext">{{ project.team_videographer }}</p>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Operator</small>
                                <p class="form-control-plaintext">{{ project.team_operator }}</p>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Assistant</small>
                                <p class="form-control-plaintext">{{ project.team_assistant }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delivery Medium -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Delivery medium</label>
                        <div class="form-control-plaintext">
                            {% if project.delivery_online %}<i class="bi bi-check text-success"></i> Online<br>{% endif %}
                            {% if project.delivery_usb %}<i class="bi bi-check text-success"></i> USB memory stick<br>{% endif %}
                            {% if not project.delivery_online and not project.delivery_usb %}
                                <span class="text-muted">No delivery method selected</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Event Presence -->
                    {% if project.event_presence %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">Event presence</label>
                        <p class="form-control-plaintext">{{ project.event_presence }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-file-earmark"></i> Files
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" class="mb-3">
                    {% csrf_token %}
                    <input type="hidden" name="upload_file" value="1">
                    <div class="mb-2">
                        {{ file_form.display_name }}
                    </div>
                    <div class="mb-2">
                        {{ file_form.file }}
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm w-100">
                        <i class="bi bi-upload"></i> Upload File
                    </button>
                </form>
                
                <hr>
                
                {% if files %}
                <div class="list-group">
                    {% for file in files %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ file.display_name }}</h6>
                                <small class="text-muted">
                                    {{ file.get_size_display }} | {{ file.created_at|date:"M d, Y" }}
                                </small>
                            </div>
                            <a href="{% url 'download_file' file.pk %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-download"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">No files uploaded yet</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
/* Ceremony field reordering styles */
.ceremony-fields.reordering {
    position: relative;
}

.ceremony-field-item {
    position: relative;
    transition: all 0.3s ease;
}

.ceremony-field-item.dragging {
    opacity: 0.5;
}

.ceremony-field-item .drag-handle {
    position: absolute;
    left: -25px;
    top: 35px;
    cursor: move;
    padding: 5px;
}

.ceremony-field-item.reorderable {
    padding-left: 30px;
    border: 1px dashed #dee2e6;
    border-radius: 0.25rem;
    padding: 15px 15px 15px 40px;
    margin-bottom: 10px;
    background-color: rgba(255, 255, 255, 0.05);
}

.ceremony-field-item.reorderable:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.ceremony-field-item.sortable-ghost {
    background-color: rgba(13, 110, 253, 0.1);
    border-color: #0d6efd;
}

.reorder-mode .field-content {
    pointer-events: none;
}

/* Tab System Styles */
.btn-group .btn.active {
    background-color: rgba(13, 110, 253, 0.8);
    border-color: #0d6efd;
    color: white;
}

.tab-content {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Timeline Styles */
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -22px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
}

.timeline-content {
    background: rgba(255, 255, 255, 0.05);
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #0d6efd;
}

.timeline-content h6 {
    margin-bottom: 5px;
    color: #fff;
}

.timeline-content p {
    margin-bottom: 5px;
    color: #adb5bd;
}

/* Empty Field Highlighting */
.field-empty {
    background-color: rgba(255, 193, 7, 0.1) !important;
    border-left: 3px solid #ffc107 !important;
    position: relative;
    padding: 8px 12px !important;
    border-radius: 4px;
    margin: 2px 0;
}

.field-empty::after {
    content: "⚠️ Not filled";
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.75rem;
    color: #856404;
    background: rgba(255, 193, 7, 0.2);
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: 500;
}

.field-empty.form-control-plaintext {
    color: #856404 !important;
    font-style: italic;
}

/* Pulse animation for new rejection notifications */
@keyframes pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
    }
    50% {
        transform: scale(1.02);
        box-shadow: 0 0 0 8px rgba(220, 53, 69, 0.1);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
    }
}
</style>

<!-- Load SortableJS from CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// Store original values for cancel functionality
let originalValues = {};

// Function to highlight empty fields
function highlightEmptyFields() {
    console.log('🔍 Checking for empty fields...');
    
    // Find all view-mode paragraphs and check if they're empty
    document.querySelectorAll('.view-mode .form-control-plaintext').forEach(field => {
        const text = field.textContent.trim();
        const isEmpty = text === 'Not specified' || text === '' || text === 'Not filled' || text === 'No editing notes yet' || text === 'No production notes yet' || text === 'No additional equipment' || text === 'No montages selected' || text === 'No format selected' || text === 'No delivery method selected';
        
        if (isEmpty) {
            field.classList.add('field-empty');
            console.log('⚠️ Empty field found:', text);
        } else {
            field.classList.remove('field-empty');
        }
    });
    
    // Also check delivery medium and other multi-option fields
    document.querySelectorAll('.view-mode .form-control-plaintext').forEach(field => {
        const parent = field.closest('.mb-3');
        if (parent) {
            const label = parent.querySelector('.form-label');
            if (label) {
                const labelText = label.textContent.trim();
                const fieldText = field.textContent.trim();
                
                // Special cases for specific field types
                if ((labelText.includes('Format') || labelText.includes('Montages') || labelText.includes('Equipment') || labelText.includes('Delivery')) && 
                    (fieldText.includes('No ') || fieldText.includes('Not '))) {
                    field.classList.add('field-empty');
                }
            }
        }
    });
}

// Tab switching functionality
function switchTab(tabName) {
    console.log(`🔄 Switching to tab: ${tabName}`);
    
    // Store the current tab in sessionStorage
    sessionStorage.setItem('activeTab', tabName);
    
    // Hide all tab contents
    const allTabContents = document.querySelectorAll('.tab-content');
    allTabContents.forEach(content => {
        content.style.display = 'none';
    });
    
    // Remove active class from all tab buttons
    const allTabButtons = document.querySelectorAll('.btn-group .btn');
    allTabButtons.forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab content
    const selectedContent = document.getElementById(`${tabName}-content`);
    if (selectedContent) {
        selectedContent.style.display = 'block';
    }
    
    // Add active class to selected tab button
    const selectedButton = document.getElementById(`${tabName}-tab`);
    if (selectedButton) {
        selectedButton.classList.add('active');
    }
    
    // Cancel any active editing when switching tabs
    const editingSections = document.querySelectorAll('.editable-section.editing');
    editingSections.forEach(section => {
        const sectionName = section.getAttribute('data-section');
        if (sectionName) {
            cancelEdit(sectionName);
        }
    });
    
    // Re-highlight empty fields in the new tab
    setTimeout(() => highlightEmptyFields(), 100);
}

function toggleEdit(section) {
    const sectionElement = document.querySelector(`[data-section="${section}"]`);
    const viewModes = sectionElement.querySelectorAll('.view-mode');
    const editModes = sectionElement.querySelectorAll('.edit-mode');
    const editBtn = sectionElement.querySelector('.edit-btn');
    const editActions = sectionElement.querySelector('.edit-actions');
    const isAdmin = {{ is_admin|lower }};
    
    // Keep videographer notes visible for clients during edit mode
    const videographerFields = sectionElement.querySelectorAll('.videographer-notes-field');
    
    // Store original values
    originalValues[section] = {};
    const allFields = sectionElement.querySelectorAll('.edit-mode [data-field]');
    allFields.forEach(field => {
        const fieldName = field.getAttribute('data-field');
        let fieldValue;
        
        // Handle different field types
        if (field.type === 'checkbox') {
            fieldValue = field.checked;
        } else if (field.type === 'radio') {
            // For radio buttons, we need to find the checked one in the group
            const radioGroup = sectionElement.querySelectorAll(`input[type="radio"][data-field="${fieldName}"]`);
            fieldValue = '';
            radioGroup.forEach(radio => {
                if (radio.checked) {
                    fieldValue = radio.value;
                }
            });
        } else {
            fieldValue = field.value;
        }
        
        // Store the original value (always store, even if empty)
        originalValues[section][fieldName] = fieldValue;
        console.log(`📝 Stored original ${fieldName}: "${fieldValue}" (${typeof fieldValue})`);
    });
    
    // Also handle hidden fields that might not be visible but need to be tracked
    const hiddenFields = sectionElement.querySelectorAll('.edit-mode [data-field]');
    hiddenFields.forEach(field => {
        const fieldName = field.getAttribute('data-field');
        // Skip if already processed
        if (originalValues[section][fieldName] !== undefined) return;
        
        let fieldValue;
        if (field.type === 'checkbox') {
            fieldValue = field.checked;
        } else if (field.type === 'radio') {
            const radioGroup = sectionElement.querySelectorAll(`input[type="radio"][data-field="${fieldName}"]`);
            fieldValue = '';
            radioGroup.forEach(radio => {
                if (radio.checked) {
                    fieldValue = radio.value;
                }
            });
        } else {
            fieldValue = field.value;
        }
        
        originalValues[section][fieldName] = fieldValue;
        console.log(`Stored hidden original ${fieldName}: "${fieldValue}"`);
    });
    
    // Toggle visibility
    viewModes.forEach(vm => vm.style.display = 'none');
    editModes.forEach(em => em.style.display = 'block');
    
    // Keep videographer notes visible (read-only) for clients during edit
    if (!isAdmin) {
        videographerFields.forEach(field => {
            field.style.display = 'block';
            const viewMode = field.querySelector('.view-mode');
            if (viewMode) viewMode.style.display = 'block';
        });
    }
    
    editBtn.style.display = 'none';
    editActions.style.display = 'block';
    // Add visual editing state
    sectionElement.classList.add('editing');
    
    // Special handling for critical-production section: show hidden field when editing
    if (section === 'critical-production') {
        const criticalField = document.getElementById('critical-notes-field');
        if (criticalField) {
            criticalField.style.display = 'block';
        }
    }
}

function cancelEdit(section) {
    const sectionElement = document.querySelector(`[data-section="${section}"]`);
    const viewModes = sectionElement.querySelectorAll('.view-mode');
    const editModes = sectionElement.querySelectorAll('.edit-mode');
    const editBtn = sectionElement.querySelector('.edit-btn');
    const editActions = sectionElement.querySelector('.edit-actions');
    
    // Restore original values
    if (originalValues[section]) {
        const allFields = sectionElement.querySelectorAll('.edit-mode [data-field]');
        allFields.forEach(field => {
            const fieldName = field.getAttribute('data-field');
            const originalValue = originalValues[section][fieldName];
            
            if (originalValue !== undefined) {
                // Handle different field types
                if (field.type === 'checkbox') {
                    field.checked = originalValue;
                } else if (field.type === 'radio') {
                    field.checked = (field.value === originalValue);
                } else {
                    field.value = originalValue;
                }
            }
        });
    }
    
    // Toggle visibility back
    viewModes.forEach(vm => vm.style.display = 'block');
    editModes.forEach(em => em.style.display = 'none');
    editBtn.style.display = 'inline-block';
    editActions.style.display = 'none';
    // Remove visual editing state
    sectionElement.classList.remove('editing');
    
    // Special handling for critical-production section: hide field if empty
    if (section === 'critical-production') {
        const criticalField = document.getElementById('critical-notes-field');
        const criticalTextarea = sectionElement.querySelector('[data-field="critical_production_notes"]');
        if (criticalField && criticalTextarea && !criticalTextarea.value.trim()) {
            criticalField.style.display = 'none';
        }
    }
}

function saveSection(section) {
    console.log(`💾 STARTING SAVE for section: ${section}`);
    
    const sectionElement = document.querySelector(`[data-section="${section}"]`);
    const editModes = sectionElement.querySelectorAll('.edit-mode');
    const saveBtn = sectionElement.querySelector('.edit-actions .btn-success');
    
    // Disable save button to prevent double-clicks
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
    
    // Debug: Show all current field values
    console.log(`📊 CURRENT FIELD VALUES for ${section}:`);
    const allFieldsDebug = sectionElement.querySelectorAll('.edit-mode [data-field]');
    allFieldsDebug.forEach(field => {
        const fieldName = field.getAttribute('data-field');
        let currentValue;
        if (field.type === 'checkbox') {
            currentValue = field.checked;
        } else if (field.type === 'radio') {
            if (field.checked) currentValue = field.value;
            else return; // Skip unchecked radios for debug
        } else {
            currentValue = field.value;
        }
        console.log(`  ${fieldName}: ${currentValue} (${typeof currentValue})`);
    });
    
    // Collect all field changes in this section for BATCH UPDATE
    const changedFields = {};
    const allFields = sectionElement.querySelectorAll('.edit-mode [data-field]');
    
    allFields.forEach(field => {
        const fieldName = field.getAttribute('data-field');
        let fieldValue;
        
        // Handle different field types
        if (field.type === 'checkbox') {
            fieldValue = field.checked;
        } else if (field.type === 'radio') {
            // For radio buttons, find the checked one in the group
            const radioGroup = sectionElement.querySelectorAll(`input[type="radio"][data-field="${fieldName}"]`);
            fieldValue = '';
            radioGroup.forEach(radio => {
                if (radio.checked) {
                    fieldValue = radio.value;
                }
            });
            // Skip processing if this isn't the checked radio (avoid duplicates)
            if (!field.checked) {
                return;
            }
        } else {
            // Handle text inputs, textareas, selects
            fieldValue = field.value;
        }
        
        // Only include if value changed
        const originalValue = originalValues[section] && originalValues[section][fieldName];
        
        // Special debugging for package_type
        if (fieldName === 'package_type') {
            console.log(`🔍 PACKAGE_TYPE DEBUG: Original="${originalValue}", Current="${fieldValue}", Section="${section}"`);
            console.log('🔍 All original values for section:', originalValues[section]);
        }
        
        if (originalValue !== fieldValue) {
            console.log(`🔄 Field ${fieldName}: "${originalValue}" → "${fieldValue}"`);
            changedFields[fieldName] = fieldValue;
        } else {
            console.log(`⏭️ Field ${fieldName}: No change (${fieldValue})`);
        }
    });
    
    if (Object.keys(changedFields).length === 0) {
        // No changes made
        console.log('📝 No changes detected, canceling edit mode');
        cancelEdit(section);
        return;
    }
    
    console.log(`📦 BATCH UPDATE: Sending ${Object.keys(changedFields).length} fields in single request:`, changedFields);
    
    // Send all changes in a single batch update request
    const batchUpdatePromise = fetch(`/projects/{{ project.slug }}/batch-update/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(changedFields)
    })
    .then(response => response.json())
    .then(data => {
        console.log(`📥 BATCH UPDATE RESPONSE:`, data);
        if (data.success) {
            return { success: true, pending_approval: data.pending_approval };
        } else {
            return { success: false, error: data.error || 'Batch update failed' };
        }
    })
    .catch(error => {
        console.error('❌ BATCH UPDATE ERROR:', error);
        return { success: false, error: 'Network error: ' + error.message };
    });
    
    // Wait for batch update to complete
    batchUpdatePromise
        .then(result => {
            console.log(`💾 BATCH SAVE RESULT for ${section}:`, result);
            
            if (!result.success) {
                console.log('❌ BATCH SAVE ERROR:', result.error);
                showMessage('Error saving changes: ' + result.error, 'error');
            } else {
                console.log(`✅ ALL ${Object.keys(changedFields).length} FIELDS SAVED SUCCESSFULLY for ${section}`);
                
                // Update view mode with new values
                updateViewMode(section);
                cancelEdit(section);
                
                // Show success message
                if (result.pending_approval) {
                    showMessage('Changes submitted for admin approval', 'info');
                } else {
                    showMessage('Changes saved successfully', 'success');
                    // Reload page to show updated values
                    setTimeout(() => location.reload(), 1000);
                }
            }
        })
        .catch(error => {
            showMessage('Error saving changes: ' + error, 'error');
        })
        .finally(() => {
            // Re-enable save button
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check"></i> Save';
        });
}

function updateField(fieldName, fieldValue) {
    // Special debugging for package_type
    if (fieldName === 'package_type') {
        console.log(`🚀 SENDING TO SERVER: ${fieldName} = "${fieldValue}"`);
    }
    
    return fetch(`/projects/{{ project.slug }}/update-field/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            field_name: fieldName,
            field_value: fieldValue
        })
    })
    .then(response => response.json())
    .then(data => {
        // Special debugging for package_type
        if (fieldName === 'package_type') {
            console.log(`📥 SERVER RESPONSE for ${fieldName}:`, data);
        }
        
        if (data.success) {
            return { success: true, pending_approval: data.pending_approval };
        } else {
            return { success: false, error: data.error || 'Unknown error' };
        }
    })
    .catch(error => {
        return { success: false, error: 'Network error: ' + error.message };
    });
}

function updateViewMode(section) {
    const sectionElement = document.querySelector(`[data-section="${section}"]`);
    const editModes = sectionElement.querySelectorAll('.edit-mode');
    
    editModes.forEach(editMode => {
        const field = editMode.querySelector('[data-field]');
        if (field) {
            const fieldName = field.getAttribute('data-field');
            const newValue = field.value;
            
            // Find corresponding view mode element
            const viewMode = editMode.parentElement.querySelector('.view-mode p');
            if (viewMode) {
                viewMode.textContent = newValue || 'Not specified';
            }
        }
    });
    
    // Re-check empty fields after updating view mode
    setTimeout(() => highlightEmptyFields(), 100);
}

function showMessage(message, type) {
    // Create Bootstrap alert
    const alertDiv = document.createElement('div');
    let alertClass = 'alert-info';
    if (type === 'success') alertClass = 'alert-success';
    if (type === 'error') alertClass = 'alert-danger';
    if (type === 'warning') alertClass = 'alert-warning';
    
    alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at top of main content
    const mainContent = document.querySelector('.row');
    mainContent.insertBefore(alertDiv, mainContent.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}

function notifyClient(projectId, force = false) {
    console.log('notifyClient function called with ID:', projectId, 'force:', force);
    
    const sendNotification = () => {
        console.log('Confirmation accepted, sending request...');
        const requestBody = force ? JSON.stringify({ force: true }) : '';
        
        fetch(`/projects/${projectId}/notify/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: requestBody
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('Notification sent successfully!', 'success');
                
                // Update button appearance to reflect no unsent changes
                const notifyButton = document.querySelector('.js-notify');
                if (notifyButton && notifyButton.classList.contains('btn-warning')) {
                    notifyButton.classList.remove('btn-warning');
                    notifyButton.classList.add('btn-secondary');
                }
                
                // Replace the active clear button with a disabled one
                const clearButton = document.querySelector('.js-clear-notify');
                if (clearButton) {
                    // Create disabled version of the clear button
                    const disabledButton = clearButton.cloneNode(true);
                    disabledButton.className = 'btn btn-outline-secondary opacity-50';
                    disabledButton.disabled = true;
                    disabledButton.classList.remove('js-clear-notify');
                    disabledButton.removeAttribute('data-project-id');
                    
                    // Replace the active button with the disabled one
                    clearButton.parentNode.replaceChild(disabledButton, clearButton);
                }
            } else if (data.cooldown) {
                // Show cooldown confirmation dialog
                showConfirmation(
                    data.message,
                    function() {
                        // Resend with force parameter
                        notifyClient(projectId, true);
                    },
                    {
                        title: 'Recent Notification Sent',
                        icon: 'bi-clock-history',
                        confirmText: 'Send Anyway',
                        confirmClass: 'btn-warning'
                    }
                );
            } else {
                showMessage('Error: ' + (data.error || 'Failed to send notification'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Network error: Failed to send notification', 'error');
        });
    };
    
    if (!force) {
        showConfirmation(
            'Send notification email to client?',
            sendNotification,
            {
                title: 'Send Notification',
                icon: 'bi-envelope',
                confirmText: 'Send',
                confirmClass: 'btn-primary'
            }
        );
    } else {
        sendNotification();
    }
}

function clearNotification(projectId) {
    console.log('clearNotification function called with ID:', projectId);
    showConfirmation(
        'Clear unnotified changes for this project?',
        function() {
            console.log('Clear confirmation accepted, sending request...');
            fetch(`/projects/${projectId}/clear-notification/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Notification cleared for this project', 'success');
                    setTimeout(() => location.reload(), 800);
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to clear notification'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error: Failed to clear notification', 'error');
            });
        },
        {
            title: 'Clear Notification',
            icon: 'bi-bell-slash',
            confirmText: 'Clear',
            confirmClass: 'btn-warning'
        }
    );
}

function sendCredentials(projectId) {
    showConfirmation(
        'Send login credentials to client?',
        function() {
            fetch(`/projects/${projectId}/send-credentials/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Credentials sent successfully!', 'success');
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to send credentials'), 'error');
                }
            })
            .catch(error => {
                showMessage('Network error: ' + error.message, 'error');
            });
        },
        {
            title: 'Send Credentials',
            icon: 'bi-envelope-at',
            confirmText: 'Send',
            confirmClass: 'btn-primary'
        }
    );
}

function changeClientData(projectId) {
    // Get current data first
    fetch(`/projects/${projectId}/change-client-data/`)
    .then(response => response.json())
    .then(data => {
        // Populate modal with current data
        document.getElementById('clientName').value = data.client_name || '';
        document.getElementById('clientEmail').value = data.client_email || '';
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('changeClientModal'));
        modal.show();
        
        // Handle save button click
        const saveBtn = document.getElementById('saveClientDataBtn');
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
        
        newSaveBtn.addEventListener('click', function() {
            const newName = document.getElementById('clientName').value.trim();
            const newEmail = document.getElementById('clientEmail').value.trim();
            
            if (!newName || !newEmail) {
                showMessage('Both name and email are required', 'error');
                return;
            }
            
            // Disable button to prevent double-clicks
            newSaveBtn.disabled = true;
            newSaveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
            
            // Update client data
            fetch(`/projects/${projectId}/change-client-data/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    client_name: newName,
                    client_email: newEmail
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    modal.hide();
                    showMessage('Client data updated successfully', 'success');
                    setTimeout(() => location.reload(), 800);
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to update client data'), 'error');
                    newSaveBtn.disabled = false;
                    newSaveBtn.innerHTML = '<i class="bi bi-check"></i> Save Changes';
                }
            })
            .catch(error => {
                showMessage('Network error: ' + error.message, 'error');
                newSaveBtn.disabled = false;
                newSaveBtn.innerHTML = '<i class="bi bi-check"></i> Save Changes';
            });
        });
    })
    .catch(error => {
        showMessage('Error loading client data: ' + error.message, 'error');
    });
}

// Custom confirmation modal function (must be global)
function showConfirmation(message, onConfirm, options = {}) {
    const modal = document.getElementById('confirmationModal');
    const messageElement = document.getElementById('confirmationMessage');
    const confirmButton = document.getElementById('confirmButton');
    const modalTitle = document.getElementById('confirmationModalLabel');
    
    // Set message
    messageElement.textContent = message;
    
    // Customize button and title based on options
    if (options.title) {
        modalTitle.innerHTML = `<i class="bi ${options.icon || 'bi-exclamation-triangle'} text-warning me-2"></i>${options.title}`;
    }
    
    if (options.confirmText) {
        confirmButton.innerHTML = `<i class="bi ${options.confirmIcon || 'bi-check'}"></i> ${options.confirmText}`;
    }
    
    if (options.confirmClass) {
        confirmButton.className = `btn ${options.confirmClass}`;
    } else {
        confirmButton.className = 'btn btn-danger';
    }
    
    // Remove any existing event listeners
    const newConfirmButton = confirmButton.cloneNode(true);
    confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
    
    // Add new event listener
    newConfirmButton.addEventListener('click', function() {
        const bootstrapModal = bootstrap.Modal.getInstance(modal);
        bootstrapModal.hide();
        if (onConfirm) onConfirm();
    });
    
    // Show modal
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// Show rejection modal with reason input
function showRejectModal(modificationId, fieldName) {
    const modal = document.getElementById('rejectModal');
    const fieldNameElement = document.getElementById('rejectFieldName');
    const reasonTextarea = document.getElementById('rejectionReason');
    const confirmBtn = document.getElementById('confirmRejectBtn');
    
    // Set field name
    fieldNameElement.textContent = fieldName;
    
    // Clear previous reason
    reasonTextarea.value = '';
    
    // Remove any existing event listeners
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    // Add new event listener
    newConfirmBtn.addEventListener('click', function() {
        const reason = reasonTextarea.value.trim();
        
        if (!reason) {
            showMessage('Please provide a reason for rejection', 'error');
            return;
        }
        
        // Submit rejection with reason
        submitRejection(modificationId, reason);
    });
    
    // Show modal
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// Submit rejection with reason
function submitRejection(modificationId, reason) {
    const formData = new FormData();
    formData.append('action', 'reject');
    formData.append('notes', reason);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/projects/modification/${modificationId}/approve/`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('rejectModal'));
            modal.hide();
            
            showMessage('Modification rejected and client notified via email', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error('Failed to reject modification');
        }
    })
    .catch(error => {
        showMessage('Error rejecting modification: ' + error.message, 'error');
    });
}

// Rejected modifications section management
function toggleRejectedSection() {
    const chevron = document.getElementById('rejectedChevron');
    const body = document.getElementById('rejectedModificationsBody');
    const header = document.querySelector('#rejectedModificationsCard .card-header');
    
    // Toggle chevron direction and aria-expanded
    if (body.classList.contains('show')) {
        chevron.classList.remove('bi-chevron-down');
        chevron.classList.add('bi-chevron-up');
        header.setAttribute('aria-expanded', 'false');
    } else {
        chevron.classList.remove('bi-chevron-up');
        chevron.classList.add('bi-chevron-down');
        header.setAttribute('aria-expanded', 'true');
        
        // Mark rejections as seen when user manually expands
        markRejectionsAsSeen();
    }
}

function dismissRejectedSection(event) {
    event.stopPropagation(); // Prevent triggering the collapse
    
    const card = document.getElementById('rejectedModificationsCard');
    const minimizedBar = document.getElementById('rejectedMinimizedBar');
    
    // Mark all rejections as seen when dismissing
    markRejectionsAsSeen();
    
    // Hide the full card
    card.classList.add('d-none');
    
    // Show the minimized bar
    minimizedBar.classList.remove('d-none');
    
    // Save dismiss state in localStorage
    localStorage.setItem('rejectedSectionDismissed', 'true');
    
    showMessage('Rejected notifications minimized. Click the warning bar to review them again.', 'info');
}

function showRejectedSection() {
    const card = document.getElementById('rejectedModificationsCard');
    const minimizedBar = document.getElementById('rejectedMinimizedBar');
    
    // Show the full card
    card.classList.remove('d-none');
    
    // Hide the minimized bar
    minimizedBar.classList.add('d-none');
    
    // Remove dismiss state from localStorage
    localStorage.removeItem('rejectedSectionDismissed');
    
    // Expand the section if it was collapsed
    const body = document.getElementById('rejectedModificationsBody');
    const chevron = document.getElementById('rejectedChevron');
    
    if (!body.classList.contains('show')) {
        const collapse = new bootstrap.Collapse(body, { show: true });
        chevron.classList.remove('bi-chevron-up');
        chevron.classList.add('bi-chevron-down');
    }
}

// Update the rejected count in the UI
function updateRejectedCount() {
    const rejectedItems = document.querySelectorAll('#rejectedModificationsBody .border-danger');
    const rejectedCount = rejectedItems.length;
    
    console.log('📊 Found', rejectedCount, 'rejected modifications');
    
    // Update badge count
    const countBadge = document.getElementById('rejectedCount');
    if (countBadge) {
        countBadge.textContent = rejectedCount;
    }
    
    // Update minimized bar count
    const minimizedCount = document.getElementById('rejectedMinimizedCount');
    if (minimizedCount) {
        const plural = rejectedCount === 1 ? 'change' : 'changes';
        minimizedCount.textContent = `${rejectedCount} rejected ${plural}`;
    }
    
    // Hide the entire section if no rejected modifications
    const card = document.getElementById('rejectedModificationsCard');
    if (card) {
        if (rejectedCount === 0) {
            card.style.display = 'none';
            console.log('🚫 No rejected modifications, hiding section');
        } else {
            card.style.display = 'block';
            console.log('✅ Showing section with', rejectedCount, 'rejected modifications');
        }
    }
}

// Auto-dismiss rejected section after 10 seconds if not interacted with
function autoMinimizeRejectedSection() {
    const card = document.getElementById('rejectedModificationsCard');
    const header = card?.querySelector('.card-header');
    
    if (!card || !header) return;
    
    console.log('🔍 Checking rejection section state...');
    
    // Check if user has manually dismissed the section
    if (localStorage.getItem('rejectedSectionDismissed') === 'true') {
        console.log('📦 Section was dismissed, showing minimized bar');
        const minimizedBar = document.getElementById('rejectedMinimizedBar');
        
        if (card && minimizedBar) {
            card.classList.add('d-none');
            minimizedBar.classList.remove('d-none');
        }
        return;
    }
    
    // Check if all rejections have been seen
    const hasUnseenRejections = checkForNewRejections();
    console.log('👁️ Has unseen rejections:', hasUnseenRejections);
    
    if (hasUnseenRejections) {
        console.log('🚨 Found unseen rejections, expanding section');
        // Expand the section for new rejections
        const body = document.getElementById('rejectedModificationsBody');
        const chevron = document.getElementById('rejectedChevron');
        
        if (body && !body.classList.contains('show')) {
            const collapse = new bootstrap.Collapse(body, { show: true });
            chevron.classList.remove('bi-chevron-up');
            chevron.classList.add('bi-chevron-down');
            header.setAttribute('aria-expanded', 'true');
        }
        
        // Show with accent color for new rejections
        showNewRejectionHighlight(header);
        
        // Auto-fade to normal after 30 seconds and mark as seen
        setTimeout(() => {
            console.log('⏰ 30 seconds passed, marking rejections as seen');
            fadeToNormalVisibility(header);
            markRejectionsAsSeen(); // Mark all current rejections as seen
        }, 30000);
        
        return; // Don't auto-minimize if there are new rejections
    }
    
    console.log('✅ All rejections have been seen, keeping section collapsed');
    
    // Auto-minimize after 15 seconds if user hasn't interacted (for old seen rejections)
    setTimeout(() => {
        // Only auto-minimize if user hasn't manually dismissed it
        if (localStorage.getItem('rejectedSectionDismissed') !== 'true' && 
            !card.classList.contains('d-none')) {
            
            const body = document.getElementById('rejectedModificationsBody');
            const chevron = document.getElementById('rejectedChevron');
            
            // Just collapse it, don't fully dismiss
            if (body && body.classList.contains('show')) {
                const collapse = new bootstrap.Collapse(body, { hide: true });
                chevron.classList.remove('bi-chevron-down');
                chevron.classList.add('bi-chevron-up');
                header.setAttribute('aria-expanded', 'false');
                
                showMessage('Rejected notifications collapsed automatically. Click the header to expand.', 'info');
            }
        }
    }, 15000); // 15 seconds
}

// Check if there are unseen rejections
function checkForNewRejections() {
    const rejectedItems = document.querySelectorAll('#rejectedModificationsBody .border-danger');
    const seenRejections = JSON.parse(localStorage.getItem('seenRejections') || '[]');
    
    console.log('🔍 Found', rejectedItems.length, 'rejected items');
    console.log('📚 Previously seen rejections:', seenRejections);
    
    for (let item of rejectedItems) {
        // Create a more reliable unique identifier using field name and rejection reason
        const fieldName = item.querySelector('h6.text-danger')?.textContent?.trim();
        const reasonElement = item.querySelector('.alert-warning');
        const reasonText = reasonElement ? reasonElement.textContent.replace('Rejection Reason:', '').trim().substring(0, 50) : '';
        const rejectionId = `${fieldName}_${reasonText}`;
        
        console.log('🔍 Checking rejection:', rejectionId);
        
        if (!seenRejections.includes(rejectionId)) {
            console.log('🆕 Found unseen rejection:', rejectionId);
            return true; // Found unseen rejection
        }
    }
    
    console.log('✅ All rejections have been seen');
    return false;
}

// Mark all current rejections as seen
function markRejectionsAsSeen() {
    const rejectedItems = document.querySelectorAll('#rejectedModificationsBody .border-danger');
    const seenRejections = JSON.parse(localStorage.getItem('seenRejections') || '[]');
    
    console.log('📝 Marking', rejectedItems.length, 'rejections as seen');
    
    rejectedItems.forEach(item => {
        const fieldName = item.querySelector('h6.text-danger')?.textContent?.trim();
        const reasonElement = item.querySelector('.alert-warning');
        const reasonText = reasonElement ? reasonElement.textContent.replace('Rejection Reason:', '').trim().substring(0, 50) : '';
        const rejectionId = `${fieldName}_${reasonText}`;
        
        if (!seenRejections.includes(rejectionId)) {
            seenRejections.push(rejectionId);
            console.log('✅ Marked as seen:', rejectionId);
        }
    });
    
    localStorage.setItem('seenRejections', JSON.stringify(seenRejections));
    console.log('💾 Updated seen rejections:', seenRejections);
}

// Show header with accent color for new rejections
function showNewRejectionHighlight(header) {
    header.style.backgroundColor = 'rgba(220, 53, 69, 0.4)';
    header.style.borderBottom = '2px solid rgba(220, 53, 69, 0.6)';
    
    // Make all elements more visible
    const icon = header.querySelector('.bi-x-circle');
    const title = header.querySelector('#rejectedSectionTitle');
    const badge = header.querySelector('.badge');
    const chevron = header.querySelector('#rejectedChevron');
    const button = header.querySelector('button');
    
    if (icon) icon.style.opacity = '1';
    if (title) title.style.opacity = '1';
    if (badge) {
        badge.style.backgroundColor = 'rgba(220, 53, 69, 0.3)';
        badge.style.color = '#dc3545';
    }
    if (chevron) chevron.style.opacity = '0.8';
    if (button) button.style.opacity = '0.9';
    
    // Add a subtle pulse animation
    header.style.animation = 'pulse 2s ease-in-out 3';
}

// Fade back to normal visibility
function fadeToNormalVisibility(header) {
    header.style.transition = 'all 2s ease-out';
    header.style.backgroundColor = 'rgba(108, 117, 125, 0.15)';
    header.style.borderBottom = '1px solid rgba(220, 53, 69, 0.2)';
    
    // Reset element opacities
    const icon = header.querySelector('.bi-x-circle');
    const title = header.querySelector('#rejectedSectionTitle');
    const badge = header.querySelector('.badge');
    const chevron = header.querySelector('#rejectedChevron');
    const button = header.querySelector('button');
    
    if (icon) icon.style.opacity = '0.6';
    if (title) title.style.opacity = '0.7';
    if (badge) {
        badge.style.backgroundColor = 'rgba(220, 53, 69, 0.15)';
        badge.style.color = '';
    }
    if (chevron) chevron.style.opacity = '0.5';
    if (button) button.style.opacity = '0.6';
    
    // Remove animation
    header.style.animation = '';
    
    // Remove transition after fade completes
    setTimeout(() => {
        header.style.transition = '';
    }, 2000);
}

// Attach click handlers without inline JS to avoid IDE lint errors
document.addEventListener('DOMContentLoaded', function() {
    // Restore the active tab from sessionStorage
    const savedTab = sessionStorage.getItem('activeTab');
    if (savedTab) {
        console.log(`🔄 Restoring saved tab: ${savedTab}`);
        switchTab(savedTab);
    }
    
    const notifyButtons = document.querySelectorAll('.js-notify');
    console.log('Found notify buttons:', notifyButtons.length);
    notifyButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-project-id');
            console.log('Notify button clicked, project ID:', id);
            if (id) notifyClient(id);
        });
    });
    const clearButtons = document.querySelectorAll('.js-clear-notify');
    console.log('Found clear buttons:', clearButtons.length);
    clearButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-project-id');
            console.log('Clear button clicked, project ID:', id);
            if (id) clearNotification(id);
        });
    });
    
    const credentialsButtons = document.querySelectorAll('.js-send-credentials');
    credentialsButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-project-id');
            if (id) sendCredentials(id);
        });
    });
    
    const changeClientButtons = document.querySelectorAll('.js-change-client');
    changeClientButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-project-id');
            if (id) changeClientData(id);
        });
    });
    
    // Archive and delete project handlers
    const archiveButtons = document.querySelectorAll('.js-archive-project');
    archiveButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const url = this.getAttribute('data-url');
            showConfirmation(
                'Are you sure you want to archive this project?',
                function() {
                    window.location.href = url;
                },
                {
                    title: 'Archive Project',
                    icon: 'bi-archive',
                    confirmText: 'Archive',
                    confirmClass: 'btn-warning'
                }
            );
        });
    });
    
    const deleteButtons = document.querySelectorAll('.js-delete-project');
    deleteButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const url = this.getAttribute('data-url');
            showConfirmation(
                'Are you sure you want to permanently delete this project? This action cannot be undone.',
                function() {
                    window.location.href = url;
                },
                {
                    title: 'Delete Project',
                    icon: 'bi-trash',
                    confirmText: 'Delete',
                    confirmClass: 'btn-danger'
                }
            );
        });
    });

    // Inline editing handlers
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const section = this.getAttribute('data-section');
            if (section) toggleEdit(section);
        });
    });
    document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const section = this.getAttribute('data-section');
            if (section) saveSection(section);
        });
    });
    document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const section = this.getAttribute('data-section');
            if (section) cancelEdit(section);
        });
    });
    
    // Reordering functionality
    let sortableInstance = null;
    const reorderBtn = document.querySelector('.reorder-btn[data-section="ceremony"]');
    const saveOrderBtn = document.querySelector('.save-order-btn');
    const cancelReorderBtn = document.querySelector('.cancel-reorder-btn');
    
    if (reorderBtn) {
        reorderBtn.addEventListener('click', function() {
            startReordering();
        });
    }
    
    if (saveOrderBtn) {
        saveOrderBtn.addEventListener('click', function() {
            saveFieldOrder();
        });
    }
    
    if (cancelReorderBtn) {
        cancelReorderBtn.addEventListener('click', function() {
            cancelReordering();
        });
    }
    
    function startReordering() {
        const container = document.getElementById('ceremony-fields-container');
        const editBtn = document.querySelector('.edit-btn[data-section="ceremony"]');
        const reorderBtn = document.querySelector('.reorder-btn[data-section="ceremony"]');
        const reorderActions = document.querySelector('.reorder-actions');
        
        // Hide edit button and reorder button
        editBtn.style.display = 'none';
        reorderBtn.style.display = 'none';
        reorderActions.style.display = 'block';
        
        // Add reorder mode class
        container.classList.add('reorder-mode');
        
        // Show drag handles and add reorderable class
        document.querySelectorAll('.ceremony-field-item').forEach(item => {
            item.classList.add('reorderable');
            const handle = item.querySelector('.drag-handle');
            if (handle) handle.style.display = 'block';
        });
        
        // Initialize Sortable
        sortableInstance = Sortable.create(container, {
            handle: '.drag-handle',
            animation: 150,
            ghostClass: 'sortable-ghost',
            dragClass: 'dragging',
            onEnd: function(evt) {
                // Field order changed, enable save button
                const saveBtn = document.querySelector('.save-order-btn');
                if (saveBtn) saveBtn.disabled = false;
            }
        });
    }
    
    function cancelReordering() {
        const container = document.getElementById('ceremony-fields-container');
        const editBtn = document.querySelector('.edit-btn[data-section="ceremony"]');
        const reorderBtn = document.querySelector('.reorder-btn[data-section="ceremony"]');
        const reorderActions = document.querySelector('.reorder-actions');
        
        // Destroy sortable instance
        if (sortableInstance) {
            sortableInstance.destroy();
            sortableInstance = null;
        }
        
        // Show edit and reorder buttons
        editBtn.style.display = 'inline-block';
        reorderBtn.style.display = 'inline-block';
        reorderActions.style.display = 'none';
        
        // Remove reorder mode
        container.classList.remove('reorder-mode');
        
        // Hide drag handles and remove reorderable class
        document.querySelectorAll('.ceremony-field-item').forEach(item => {
            item.classList.remove('reorderable');
            const handle = item.querySelector('.drag-handle');
            if (handle) handle.style.display = 'none';
        });
        
        // Reload to restore original order
        location.reload();
    }
    
    function saveFieldOrder() {
        const container = document.getElementById('ceremony-fields-container');
        const fieldItems = container.querySelectorAll('.ceremony-field-item');
        const fieldOrder = [];
        
        fieldItems.forEach(item => {
            const fieldName = item.getAttribute('data-field-name');
            if (fieldName) fieldOrder.push(fieldName);
        });
        
        // Send to server
        fetch(`/projects/{{ project.slug }}/update-field-order/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                field_order: fieldOrder
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('Field order saved successfully', 'success');
                // Clean up reorder mode
                cancelReordering();
            } else {
                showMessage('Error saving field order: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            showMessage('Network error: ' + error.message, 'error');
        });
    }
    
    // Movie duration dropdown handling
    const movieCheckbox = document.querySelector('input[data-field="montage_movie"]');
    const durationSection = document.getElementById('movie-duration-section');
    const durationSelect = document.querySelector('select[data-field="montage_movie_duration"]');
    const otherInput = document.querySelector('input[data-field="montage_movie_other"]');
    
    if (movieCheckbox && durationSection) {
        movieCheckbox.addEventListener('change', function() {
            if (this.checked) {
                durationSection.style.display = 'block';
            } else {
                durationSection.style.display = 'none';
                // Clear duration fields when movie is unchecked
                if (durationSelect) {
                    durationSelect.value = '';
                    // Send update to clear duration
                    updateField('montage_movie_duration', '');
                }
                if (otherInput) {
                    otherInput.style.display = 'none';
                    otherInput.value = '';
                    // Send update to clear other duration
                    updateField('montage_movie_other', '');
                }
            }
            // Send the checkbox update
            updateField('montage_movie', this.checked);
        });
    }
    
    if (durationSelect && otherInput) {
        durationSelect.addEventListener('change', function() {
            if (this.value === 'Other') {
                otherInput.style.display = 'block';
            } else {
                otherInput.style.display = 'none';
                otherInput.value = '';
                // Clear other duration when not "Other"
                updateField('montage_movie_other', '');
            }
            // Send the duration update
            updateField('montage_movie_duration', this.value);
        });
    }
    
    if (otherInput) {
        otherInput.addEventListener('change', function() {
            // Send the other duration update
            updateField('montage_movie_other', this.value);
        });
    }
    
    // Enhanced real-time update listeners for package fields
    function setupPackageFieldListeners() {
        console.log('Setting up package field listeners...');
        
        // Package type dropdown
        const packageTypeField = document.querySelector('select[data-field="package_type"]');
        if (packageTypeField) {
            packageTypeField.addEventListener('change', function() {
                console.log(`📦 Package type changed to: ${this.value}`);
                // Apply preset instantly if a valid type is selected (no server call)
                if (this.value && packagePresets[this.value]) {
                    console.log(`🎯 Applying preset for: ${this.value}`);
                    applyPackagePreset(this.value);
                } else {
                    console.log(`⚠️ No preset found for: ${this.value}`);
                }
                // Note: Server save will happen when user clicks "Save" button
            });
        }
        
        // Size format checkboxes
        const package4kField = document.querySelector('input[data-field="package_4k"]');
        if (package4kField) {
            package4kField.addEventListener('change', function() {
                console.log('4K changed to:', this.checked);
                updateFieldWithFeedback('package_4k', this.checked);
            });
        }
        
        const packageFullhdField = document.querySelector('input[data-field="package_fullhd"]');
        if (packageFullhdField) {
            packageFullhdField.addEventListener('change', function() {
                console.log('FullHD changed to:', this.checked);
                updateFieldWithFeedback('package_fullhd', this.checked);
            });
        }
        
        // Camera radio buttons - handle as a group
        const cameraRadios = document.querySelectorAll('input[data-field="package_cameras"]');
        cameraRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    console.log('Cameras changed to:', this.value);
                    updateFieldWithFeedback('package_cameras', this.value);
                }
            });
        });
        
        // Montage checkboxes (excluding special ones)
        const montageHighlights = document.querySelector('input[data-field="montage_highlights"]');
        if (montageHighlights) {
            montageHighlights.addEventListener('change', function() {
                console.log('Highlights changed to:', this.checked);
                updateFieldWithFeedback('montage_highlights', this.checked);
            });
        }
        
        const montageMovie = document.querySelector('input[data-field="montage_movie"]');
        if (montageMovie) {
            montageMovie.addEventListener('change', function() {
                console.log('Movie changed to:', this.checked);
                updateFieldWithFeedback('montage_movie', this.checked);
                
                // Show/hide movie duration section
                const durationSection = document.getElementById('movie-duration-section');
                if (durationSection) {
                    if (this.checked) {
                        durationSection.style.display = 'block';
                    } else {
                        durationSection.style.display = 'none';
                    }
                }
            });
        }
        
        const montageBonus = document.querySelector('input[data-field="montage_bonus_full"]');
        if (montageBonus) {
            montageBonus.addEventListener('change', function() {
                console.log('Cinema style movie changed to:', this.checked);
                updateFieldWithFeedback('montage_bonus_full', this.checked);
                
                // Show/hide cinema duration section
                const cinemaDurationSection = document.getElementById('cinema-duration-section');
                if (cinemaDurationSection) {
                    if (this.checked) {
                        cinemaDurationSection.style.display = 'block';
                    } else {
                        cinemaDurationSection.style.display = 'none';
                    }
                }
            });
        }
        
        const cinemaDuration = document.querySelector('select[data-field="montage_cinema_duration"]');
        if (cinemaDuration) {
            cinemaDuration.addEventListener('change', function() {
                console.log('Cinema duration changed to:', this.value);
                updateFieldWithFeedback('montage_cinema_duration', this.value);
            });
        }
        
        const montagePrimary = document.querySelector('input[data-field="montage_bonus_primary"]');
        if (montagePrimary) {
            montagePrimary.addEventListener('change', function() {
                console.log('Primary edit changed to:', this.checked);
                updateFieldWithFeedback('montage_bonus_primary', this.checked);
            });
        }
        
        
        // Equipment checkboxes
        const equipmentFields = ['equipment_audio_recorder', 'equipment_stabilizer', 'equipment_external_light'];
        equipmentFields.forEach(fieldName => {
            const field = document.querySelector(`input[data-field="${fieldName}"]`);
            if (field) {
                field.addEventListener('change', function() {
                    console.log(`${fieldName} changed to:`, this.checked);
                    updateFieldWithFeedback(fieldName, this.checked);
                });
            }
        });
        
        // Team number fields
        const teamFields = ['team_videographer', 'team_operator', 'team_assistant'];
        teamFields.forEach(fieldName => {
            const field = document.querySelector(`input[data-field="${fieldName}"]`);
            if (field) {
                field.addEventListener('change', function() {
                    console.log(`${fieldName} changed to:`, this.value);
                    updateFieldWithFeedback(fieldName, this.value);
                });
            }
        });
        
        // Delivery checkboxes
        const deliveryOnline = document.querySelector('input[data-field="delivery_online"]');
        if (deliveryOnline) {
            deliveryOnline.addEventListener('change', function() {
                console.log('Online delivery changed to:', this.checked);
                updateFieldWithFeedback('delivery_online', this.checked);
            });
        }
        
        const deliveryUsb = document.querySelector('input[data-field="delivery_usb"]');
        if (deliveryUsb) {
            deliveryUsb.addEventListener('change', function() {
                console.log('USB delivery changed to:', this.checked);
                updateFieldWithFeedback('delivery_usb', this.checked);
            });
        }
        
        // Event presence textarea
        const eventPresence = document.querySelector('textarea[data-field="event_presence"]');
        if (eventPresence) {
            eventPresence.addEventListener('blur', function() {
                console.log('Event presence changed to:', this.value);
                updateFieldWithFeedback('event_presence', this.value);
            });
        }
    }
    
    // Load package presets from server (loaded once)
    const packagePresets = JSON.parse('{{ package_presets|escapejs }}');
    console.log('📦 Package presets loaded:', packagePresets);
    
    // Brief success indicator for fields
    function showFieldSuccess(fieldName) {
        const field = document.querySelector(`[data-field="${fieldName}"]`);
        if (field) {
            field.style.borderColor = '#28a745';
            setTimeout(() => {
                field.style.borderColor = '';
            }, 1000);
        }
    }
    
    // Initialize package field listeners
    setupPackageFieldListeners();
    
    // Initialize empty field highlighting
    highlightEmptyFields();

    // Remove duplicate package type handler - it's now handled in setupPackageFieldListeners
    
    // Simple and fast package preset application (no server calls during preset selection)
    function applyPackagePreset(presetName) {
        console.log(`🎯 APPLYING PRESET: ${presetName}`);
        const preset = packagePresets[presetName];
        if (!preset) {
            console.error('Preset not found:', presetName);
            return;
        }
        
        console.log(`📋 PRESET DATA for ${presetName}:`, preset);
        
        // Apply all values instantly from the loaded preset data
        Object.keys(preset).forEach(fieldName => {
            const value = preset[fieldName];
            
            // Handle checkboxes
            const checkbox = document.querySelector(`input[type="checkbox"][data-field="${fieldName}"]`);
            if (checkbox) {
                const oldValue = checkbox.checked;
                checkbox.checked = value;
                console.log(`✓ ${fieldName}: ${oldValue} → ${value} (checkbox)`);
                return;
            }
            
            // Handle radio buttons (cameras)
            if (fieldName === 'package_cameras') {
                const radios = document.querySelectorAll(`input[type="radio"][data-field="${fieldName}"]`);
                let oldValue = '';
                radios.forEach(radio => {
                    if (radio.checked) oldValue = radio.value;
                    radio.checked = (radio.value == value);
                });
                console.log(`✓ ${fieldName}: ${oldValue} → ${value} (radio)`);
                return;
            }
            
            // Handle number inputs
            const numberInput = document.querySelector(`input[type="number"][data-field="${fieldName}"]`);
            if (numberInput) {
                const oldValue = numberInput.value;
                numberInput.value = value;
                console.log(`✓ ${fieldName}: ${oldValue} → ${value} (number)`);
                return;
            }
            
            // Handle select dropdowns (cinema duration)
            const selectInput = document.querySelector(`select[data-field="${fieldName}"]`);
            if (selectInput) {
                const oldValue = selectInput.value;
                selectInput.value = value;
                console.log(`✓ ${fieldName}: ${oldValue} → ${value} (select)`);
                return;
            }
            
            console.log(`⚠️ FIELD NOT FOUND: ${fieldName} (value: ${value})`);
        });
        
        // Handle movie duration visibility
        const movieCheckbox = document.querySelector('input[data-field="montage_movie"]');
        const durationSection = document.getElementById('movie-duration-section');
        if (movieCheckbox && durationSection) {
            if (preset.montage_movie) {
                durationSection.style.display = 'block';
            } else {
                durationSection.style.display = 'none';
            }
        }
        
        // Handle cinema duration visibility
        const cinemaCheckbox = document.querySelector('input[data-field="montage_bonus_full"]');
        const cinemaDurationSection = document.getElementById('cinema-duration-section');
        if (cinemaCheckbox && cinemaDurationSection) {
            if (preset.montage_bonus_full) {
                cinemaDurationSection.style.display = 'block';
            } else {
                cinemaDurationSection.style.display = 'none';
            }
        }
        
        console.log('✅ Package preset applied instantly - no server call needed!');
        
        // CRITICAL FIX: Update original values to reflect the preset changes
        // This ensures that when Save is clicked, the changes are detected properly
        if (!originalValues['package']) {
            originalValues['package'] = {};
        }
        
        // Reset original values to empty/default so preset changes are detected as changes
        Object.keys(preset).forEach(fieldName => {
            // Set original value to something different so the change is detected
            if (typeof preset[fieldName] === 'boolean') {
                originalValues['package'][fieldName] = !preset[fieldName]; // Opposite boolean
            } else if (typeof preset[fieldName] === 'number') {
                originalValues['package'][fieldName] = 0; // Default number
            } else {
                originalValues['package'][fieldName] = ''; // Empty string
            }
            console.log(`🔄 Updated original ${fieldName}: "${originalValues['package'][fieldName]}" (will detect change to "${preset[fieldName]}")`);
        });
        
        // Show immediate success message
        showMessage('Package preset applied instantly!', 'success');
    }
    
    // Initialize rejected modifications section behavior
    updateRejectedCount();
    autoMinimizeRejectedSection();
});
</script>

<!-- Custom Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    Confirm Action
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage" class="mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmButton">
                    <i class="bi bi-check"></i> Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Change Client Data Modal -->
<div class="modal fade" id="changeClientModal" tabindex="-1" aria-labelledby="changeClientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeClientModalLabel">
                    <i class="bi bi-person-gear text-success me-2"></i>
                    Change Client Data
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="changeClientForm">
                    <div class="mb-3">
                        <label for="clientName" class="form-label">Client Name</label>
                        <input type="text" class="form-control" id="clientName" required>
                    </div>
                    <div class="mb-3">
                        <label for="clientEmail" class="form-label">Client Email</label>
                        <input type="email" class="form-control" id="clientEmail" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x"></i> Cancel
                </button>
                <button type="button" class="btn btn-success" id="saveClientDataBtn">
                    <i class="bi bi-check"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modification Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">
                    <i class="bi bi-x-circle text-danger me-2"></i>
                    Reject Modification
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You are about to reject the modification for <strong id="rejectFieldName"></strong>.</p>
                <p class="text-warning">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    Please provide a reason for rejection. This will be sent to the client via email.
                </p>
                <form id="rejectForm">
                    <div class="mb-3">
                        <label for="rejectionReason" class="form-label">Rejection Reason <span class="text-danger">*</span></label>
                        <textarea class="form-control" 
                                  id="rejectionReason" 
                                  name="notes" 
                                  rows="4" 
                                  placeholder="Please explain why this change was rejected..."
                                  required></textarea>
                        <div class="form-text text-muted">
                            This message will be sent to the client to help them understand what needs to be corrected.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmRejectBtn">
                    <i class="bi bi-send"></i> Send Rejection
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Field History Modal -->
<div class="modal fade" id="fieldHistoryModal" tabindex="-1" aria-labelledby="fieldHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fieldHistoryModalLabel">
                    <i class="bi bi-clock-history text-info me-2"></i>
                    Edit History: <span id="historyFieldName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="fieldHistoryContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading history...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Field History functionality
document.addEventListener('DOMContentLoaded', function() {
    const historyButtons = document.querySelectorAll('.history-btn');
    const historyModal = new bootstrap.Modal(document.getElementById('fieldHistoryModal'));
    
    historyButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const fieldName = this.getAttribute('data-field');
            showFieldHistory(fieldName);
        });
    });
    
    function showFieldHistory(fieldName) {
        const projectSlug = '{{ project.slug }}';
        const modalTitle = document.getElementById('historyFieldName');
        const historyContent = document.getElementById('fieldHistoryContent');
        
        // Set field name in modal title
        const fieldDisplayName = fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        modalTitle.textContent = fieldDisplayName;
        
        // Show loading state
        historyContent.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading history...</p>
            </div>
        `;
        
        // Show modal
        historyModal.show();
        
        // Fetch history
        fetch(`/projects/${projectSlug}/field-history/${fieldName}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch history');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.history.length > 0) {
                    renderHistory(data.history);
                } else {
                    historyContent.innerHTML = `
                        <div class="text-center py-4">
                            <i class="bi bi-info-circle text-muted" style="font-size: 3rem;"></i>
                            <p class="mt-3 text-muted">No edit history available for this field yet.</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching field history:', error);
                historyContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to load history. Please try again.
                    </div>
                `;
            });
    }
    
    function renderHistory(history) {
        const historyContent = document.getElementById('fieldHistoryContent');
        
        let html = '<div class="timeline">';
        
        history.forEach((entry, index) => {
            const isFirst = index === 0;
            const oldValue = entry.old_value || '(empty)';
            const newValue = entry.new_value || '(empty)';
            
            html += `
                <div class="timeline-entry mb-4 pb-4 ${isFirst ? '' : 'border-bottom border-secondary'}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <strong class="text-info">
                                <i class="bi bi-person-circle me-1"></i>
                                ${entry.edited_by}
                            </strong>
                            ${isFirst ? '<span class="badge bg-success ms-2">Current</span>' : ''}
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-clock me-1"></i>
                            ${entry.time_ago} ago
                        </small>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label class="form-label text-muted small">Previous Value:</label>
                            <div class="p-2 border rounded text-body history-value-box history-value-old">
                                ${escapeHtml(oldValue)}
                            </div>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label text-success small">New Value:</label>
                            <div class="p-2 border border-success rounded text-body history-value-box history-value-new">
                                ${escapeHtml(newValue)}
                            </div>
                        </div>
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-calendar me-1"></i>
                        ${entry.created_at}
                    </small>
                </div>
            `;
        });
        
        html += '</div>';
        historyContent.innerHTML = html;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
});
</script>

{% endblock %}
